<tool id="pm_dftb_opt_write" name="Generate DFTB+ outputs (dftb+)" version="0.1.0" python_template_version="3.5">
    <requirements>
        <requirement type="package">dftbplus</requirement>
        <requirement type="package">pymuonsuite</requirement>
        <requirement type="package">zip</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        pip show pymuonsuite || ( git clone https://github.com/muon-spectroscopy-computational-project/pymuon-suite /tmp/pymuon-suite && pip install /tmp/pymuon-suite && rm -rf /tmp/pymuon-suite) &&
        unzip $muonated_structures &&
        if test -f "params.yaml"; then echo "params.yaml present"; else echo "params.yaml missing" && exit 64; fi 
        && if test -f "input.cell"; then echo "input.cell present"; else echo "input.cell missing" && exit 64; fi &&
        out_folder="`python ${__tool_directory__}/get_out_folder.py`" ;
        bash ${__tool_directory__}/run.sh \$out_folder ;
        passed=$? &&
        echo \$passed &&
        if [ \$passed == 2 ]; then echo "input file structure is not dftb" && exit 25; elif [ \$passed == 3 ]; then echo "error in parsing dftb file. check log for details" && exit 26; else echo "parse ok"; fi &&
        if grep -q 'pbc-0-3' params.yaml; then cp ${__tool_directory__}/README-pbc \$out_folder/README; elif grep -q '3ob-3-1' params.yaml; then cp ${__tool_directory__}/README-3ob \$out_folder README; else ( cp ${__tool_directory__}/README-3ob \$out_folder README-3ob && cp ${__tool_directory__}/README-pbc \$out_folder/README-pbc ); fi; 
        zip -r dftb_results.zip \$out_folder params.yaml input.cell &&
        find \$out_folder -printf '%h\0%d\0%p\n' | sort -t '\0' -n | awk -F '\0' '{print $3}' > tree.txt
    ]]></command>
    <inputs>
        <param type="data" name="muonated_structures" label="Muonated structures (.zip)" format="zip" help="A zip folder containing muonated structures, as generated by the 'Generate muonated structures' tool or pm-muairss." />
    </inputs>
    <outputs>
        <data label="DFTB results for $muonated_structures.name" name="dftb_results" format="zip" from_work_dir="dftb_results.zip"/>
        <data label="file tree for testing" name="file_tree" format="txt" from_work_dir="tree.txt" hidden="true"/>
    </outputs>
    <tests>
        <test>
            <param name="muonated_structures" value="muonated-dftb.zip" ftype='zip'/>
            <output name="file_tree" file="tree.txt" ftype="txt"  delta="100"/>
        </test>
    </tests>
    <help><![CDATA[
        usage: dftb+
        Given some input muonated structures (structures containing a muon), applies DFTB+ optimization to refine them.
        
        **LICENSE**

        All data is licensed under the Creative Commons Attribution-ShareAlike 4.0
        International License. The full text of the license can be found at:

        https://creativecommons.org/licenses/by-sa/4.0/legalcode

        For specific data sets remember to cite the following papers, by element :

|        **3-ob-1**


+--------------+------------------------------------------------+-----------------------------------+
| [JCTC2013]   | \ J. Chem. Theory Comput., 2013, 9, 338-354.   | (O, N, C, H)                      |
+--------------+------------------------------------------------+-----------------------------------+
| [JCTC2014]   | \ J. Chem. Theory Comput., 2014, 10, 1518-1537.| (P,S-\*)                          |
+--------------+------------------------------------------------+-----------------------------------+
| [JCTC2015-1] | \ J. Phys. Chem. B, 2015, 119, 1062-1082.      | (Mg,Zn-\*)                        |
+--------------+------------------------------------------------+-----------------------------------+
| [JCTC2015-2] | \ J. Chem. Theory Comput., 2015, 11, 332-342.  | (Na,F,K,Ca,Cl,Br,I-\*)            |
+--------------+------------------------------------------------+-----------------------------------+  

|
|    **pbc-0-3**

+------------+--------------------------------------------------------------------------------------------+---------+
|   [SiC]    | \ E. Rauls, R. Gutierrez, J. Elsner, and Th. Frauenheim, Sol. State Comm. 111, 459 (1999)  | (Si-C)  |
+------------+--------------------------------------------------------------------------------------------+---------+
|   [SiO]    | \ C. Koehler, Z. Hajnal, P. Deak, Th. Frauenheim, S. Suhai, Phys. Rev. B 64, 085333 (2001) |  (Si-O) |
+------------+--------------------------------------------------------------------------------------------+---------+
| [Silicon]  | \ A. Sieck, Th. Frauenheim, and K. A. Jackson, phys. stat. sol. (b) 240, 537 (2003).       |  (Si)   |
+------------+--------------------------------------------------------------------------------------------+---------+
| [Fluorine] | \ C. Koehler and Th. Frauenheim, Surf. Sci. 600, 453 (2006).                               | \ (F)   |
+------------+--------------------------------------------------------------------------------------------+---------+
|   [Iron]   | \ C. Koehler, G. Seifert and Th. Frauenheim, Chem. Phys. 309, 23 (2005).                   |   (Fe)  |
+------------+--------------------------------------------------------------------------------------------+---------+
|   [SiSi]   | \ A. Sieck, PhD. Thesis, University of Paderborn, 2000.                                    | (Si-Si) |
+------------+--------------------------------------------------------------------------------------------+---------+

|
| The full sets and all other data can be found at the following URLs:

+----------+------------------------------------------------------------+
|  3-ob-1  |   https://www.dftb.org/parameters/download/3ob/3ob-3-1-cc/ |
+----------+------------------------------------------------------------+
| pbc-0-3  |  https://www.dftb.org/parameters/download/pbc/pbc-0-3-cc/  |
+----------+------------------------------------------------------------+
    ]]></help>
       <citations>
        <citation type="bibtex">
            @misc{github,
                author = {{Muon Spectroscopy Computational Project}},
                year = {2021},
                title = {pymuon-suite 0.2.0},
                publisher = {GitHub},
                url = {https://github.com/muon-spectroscopy-computational-project/pymuon-suite/}
            }
        </citation>
        <citation type="bibtex">
            @article{airss,
                author = {Liborio, L. and Sturniolo, S. and Jochym, D.},
                title = {Computational prediction of muon stopping sites using ab initio random structure searching (AIRSS)},
                journal = {The Journal of Chemical Physics},
                volume = {148},
                pages = {134114},
                year = {2018},
                doi={10.1063/1.5024450},
                URL={
                    https://doi.org/10.1063/1.5024450
                },
                eprint={
                    https://doi.org/10.1063/1.5024450
                }
            }
        </citation>
        <citation type="bibtex">
            @article{doi:10.1063/1.5085197,
                author = {Sturniolo,Simone  and Liborio,Leandro  and Jackson,Samuel },
                title = {Comparison between density functional theory and density functional tight binding approaches for finding the muon stopping site in organic molecular crystals},
                journal = {The Journal of Chemical Physics},
                volume = {150},
                number = {15},
                pages = {154301},
                year = {2019},
                doi = {10.1063/1.5085197},
                URL = {
                        https://doi.org/10.1063/1.5085197
                },
                eprint = {
                        https://doi.org/10.1063/1.5085197
                }
            }
        </citation>
        <citation type="bibtex">
            @article{doi:10.1063/5.0012381,
                author = {Sturniolo,Simone  and Liborio,Leandro },
                title = {Computational prediction of muon stopping sites: A novel take on the unperturbed electrostatic potential method},
                journal = {The Journal of Chemical Physics},
                volume = {153},
                number = {4},
                pages = {044111},
                year = {2020},
                doi = {10.1063/5.0012381},
                URL = {
                        https://doi.org/10.1063/5.0012381
                },
                eprint = {
                        https://doi.org/10.1063/5.0012381
                },
                abstract = { Finding the stopping site of the muon in a muon-spin relaxation experiment is one of the main problems of muon spectroscopy, and computational techniques that make use of quantum chemistry simulations can be of great help when looking for this stopping site. The most thorough approach would require the use of simulations, such as Density Functional Theory (DFT), to test and optimise multiple possible sites, accounting for the effect that the added muon has on its surroundings. However, this can be computationally expensive and sometimes unnecessary. Hence, in this work, we present a software implementation of the Unperturbed Electrostatic Potential (UEP) Method: an approach used for finding the muon stopping site in crystalline materials. The UEP method requires only one DFT calculation, necessary to compute the electronic density. This, in turn, is used to calculate the minima of the crystalline material’s electrostatic potential and the estimates of the muon stopping site, relying on the approximation that the muon’s presence does not significantly affect its surroundings. One of the main UEP’s assumptions is that the muon stopping site will be one of the crystalline material’s electrostatic potential minima. In this regard, we also propose some symmetry-based considerations about the properties of this crystalline material’s electrostatic potential, in particular, which sites are more likely to be its minima and why the unperturbed approximation may be sufficiently robust for them. We introduce the Python software package pymuon-suite and the various utilities it provides to facilitate these calculations, and finally, we demonstrate the effectiveness of the method with some chosen example systems. }
            }
        </citation>
        <citation type="bibtex">
            @article {castep,
                author = {Clark, S. J. and Segall, M. D. and Pickard, C. J. and Hasnip, P. J. and Probert, M. I. J. and Refson, K. and Payne, M. C.},
                title = {First principles methods using CASTEP},
                journal = {Zeitschrift fuer Kristallographie},
                volume = {220},
                pages = {567},
                year = {2005}
            }
        </citation>
    </citations>
</tool>
